<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Raden Cookies Checklist</title>
  <style>
    :root{
      --bg:#0a2b1a; --card:#0f3521; --muted:#a6c2b5; --text:#f4f7f5;
      --accent:#d4b36a; --ok:#32d583; --warn:#f7a23a; --bad:#ef4444; --border:#244a36; --shadow:0 6px 30px rgba(0,0,0,.25);
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--text)}
    .container{max-width:1100px;margin:0 auto;padding:16px}
    header{display:flex;align-items:center;gap:12px;padding:12px 0 4px}
    header h1{margin:0;font-size:1.4rem}
    header .sub{color:var(--muted)}
    .card{background:linear-gradient(180deg,rgba(255,255,255,.06),rgba(255,255,255,.03));border:1px solid var(--border);border-radius:16px;padding:14px;margin:14px 0;box-shadow:var(--shadow)}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center;justify-content:space-between}
    .btn{appearance:none;background:var(--accent);color:#0b0f0c;border:none;border-radius:12px;padding:10px 14px;font-weight:800;cursor:pointer;box-shadow:0 2px 10px rgba(0,0,0,.2)}
    .btn.small{padding:8px 12px} .btn.ghost{background:transparent;color:var(--text);border:1px solid var(--border)}
    input[type="text"],input[type="date"],input[type="password"]{width:100%;padding:10px;border-radius:10px;border:1px solid var(--border);background:#0d2f1d;color:var(--text)}
    .toggles{display:flex;gap:8px;flex-wrap:wrap}
    .toggle{display:flex;gap:8px;align-items:center;background:#0d2f1d;border:1px solid var(--border);padding:8px 12px;border-radius:12px}
    .grid{display:grid;grid-template-columns:1fr;gap:14px}
    @media (min-width:700px){.grid{grid-template-columns:repeat(2,1fr)}}
    @media (min-width:1000px){.grid{grid-template-columns:repeat(3,1fr)}}
    .category header{display:flex;align-items:center;justify-content:space-between;margin-bottom:6px}
    .item{padding:8px 0;border-bottom:1px dashed var(--border)}
    .item:last-child{border-bottom:none}
    .item-row{display:grid;align-items:center;gap:8px;grid-template-columns:28px 28px 1fr minmax(120px,auto)}
    .item-photos{display:flex;gap:6px;flex-wrap:wrap;margin:6px 0}
    .thumb{height:58px;border-radius:8px;border:1px solid var(--border);cursor:pointer}
    label.file-btn{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:10px;border:1px solid var(--border);background:#0d2f1d;cursor:pointer}
    input[type="file"]{display:none}
    .kartu{border:1px solid var(--border);border-radius:12px;padding:10px;margin:8px 0;background:#0f3521}
    .kartu h4{margin:0 0 6px 0}
    .photos-row{display:flex;gap:6px;flex-wrap:wrap}
    .muted{color:var(--muted)}
    .badge{display:inline-block;padding:2px 8px;border-radius:999px;font-size:.78rem;font-weight:800;border:1px solid rgba(255,255,255,.15)}
    .warn{background:rgba(247,162,58,.12);color:var(--warn);border-color:rgba(247,162,58,.35)}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>Raden Cookies Checklist</h1>
    </header>

    <section id="auth" class="card">
      <div class="row">
        <div style="flex:1;min-width:260px">
          <label>Nama User
            <input id="username" type="text" placeholder="mis. budi" />
          </label>
        </div>
        <div style="display:flex;gap:8px;align-items:flex-end">
          <button id="go-user" class="btn">Masuk User</button>
          <button id="go-admin" class="btn ghost">Masuk Admin</button>
        </div>
      </div>
    </section>

    <section id="user-app" class="card" style="display:none">
      <div class="row">
        <div><strong id="hello"></strong></div>
        <div style="display:flex;gap:8px;align-items:end">
          <label>Tanggal <input id="work-date" type="date"/></label>
          <button id="btn-today" class="btn ghost small">Hari ini</button>
          <button id="btn-logout" class="btn ghost small">Keluar</button>
        </div>
      </div>
      <div class="card" style="margin-top:10px">
        <h3 style="margin:6px 0">Pilih kategori yang diisi hari ini</h3>
        <div id="cat-toggles" class="toggles"></div>
      </div>
      <div id="cats" class="grid"></div>
      <div class="row">
        <div class="muted">Semua item pada kategori terpilih harus dicentang. Item berlabel <span class="badge warn">foto wajib</span> wajib ada fotonya.</div>
        <button id="btn-submit" class="btn">Tandai Selesai & Simpan ke Server</button>
      </div>
    </section>

    <section id="admin-app" class="card" style="display:none">
      <div class="row">
        <div><strong>Admin Panel</strong></div>
        <div style="display:flex;gap:8px;align-items:end">
          <label>Dari <input id="from-date" type="date" /></label>
          <label>Sampai <input id="to-date" type="date" /></label>
          <button id="btn-load" class="btn">Muat Data</button>
        </div>
      </div>
      <div id="admin-list"></div>
    </section>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
  /************ CONFIG ************/
  const SUPABASE_URL = "https://ofxjfleedebeunvcbkcv.supabase.co"; 
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9meGpmbGVlZGViZXVudmNia2N2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU4NDQxMjIsImV4cCI6MjA3MTQyMDEyMn0.wxCH2Ftn5DelN4FjXoMXVLwi7zwLUzwRKyFYupo8MXM"; 
  const BUCKET = "photos";                                      // pastikan ada bucket public 'photos'
  const ADMIN_PIN = "raden1234";                                     // ganti PIN admin di sini

  /************ DATA MASTER ************/
  const CHECKLIST = {
    "General": [
      "AC","Kulkas Freezer Utama","Komputer Mati","Laptop Mati","Rak Lemari Kuker Tertutup",
      "Pintu Office Tertutup","Lampu dan Pintu Store","Sampah Office","Jendela Depan Toko Terkunci",
      "Sampah Kulit Pisang masuk Freezer","Pintu Depan Utama","Pintu Garasi Depan Utama Tertutup",
      "Semua Lantai Area Tersapu&Terpel","Semua Lantai Office&Store Bersih","Area Toko (Meja&Lantai) Rapi"
    ],
    "Hot Kitchen": [
      "Keran Gas Utama/Main Valve","Exhaust Tombol ON/OFF","Steamer Besar","Steamer Kecil","Kompor Gas",
      "Tong Sampah Hot Kitchen","Selokan Hot Kitchen","Saringan Hot Kitchen Wasfatel (per 2 Hari)",
      "Sampah Toilet Wanita","Jendela Toilet Wanita","Pintu Toilet Wanita","Kompor Bakar Depan Oven Besar",
      "Kulkas Hot Kitchen","Mesin Cuci di Toilet Wanita","AC Dapur"
    ],
    "Pastry": [
      "Oven Besar&Oven Kecil","Mesin Cap Label Kuker","Mesin Giling Kulit Bolen",
      "Saringan Wastafel Cuci Piring (Per 2 Hari)","Mixer Besar Pastry","Mixer Kecil Pastry","Saringan Tepung",
      "Kulkas Pastry","Tong Sampah Besar-Wastafel","Tong Sampah Kecil","Sampah Toilet Pria",
      "Keran Gas Manual-Toilet Pria","Jendela Kamar Mandi Pria","Pintu Kamar Mandi Pria","Microwave","AC Dapur"
    ]
  };
  const REQUIRED_PHOTO_IDX = { "General":[1,2], "Hot Kitchen":[1,5,13,15], "Pastry":[8,12,16] }; // 1-based

  /************ INIT ************/
  const supabase = (SUPABASE_URL.startsWith("https://") && SUPABASE_ANON_KEY.length>10)
    ? window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY)
    : null;

  const elAuth = document.getElementById("auth");
  const elUser = document.getElementById("user-app");
  const elAdmin = document.getElementById("admin-app");

  document.getElementById("go-user").onclick = ()=>{
    const name = document.getElementById("username").value.trim();
    if(!name) return alert("Nama user wajib diisi.");
    state.user = name;
    document.getElementById("hello").textContent = "ðŸ‘‹ Halo, " + name;
    document.getElementById("work-date").value = todayStr();
    mountUser();
  };

  document.getElementById("go-admin").onclick = ()=>{
    const pin = prompt("Masukkan PIN Admin:");
    if(pin !== ADMIN_PIN){ alert("PIN salah."); return; }
    document.getElementById("from-date").value = todayStr(-6);
    document.getElementById("to-date").value = todayStr();
    mountAdmin();
  };

  document.getElementById("btn-logout").onclick = ()=>{
    state.user = null;
    elUser.style.display="none";
    elAdmin.style.display="none";
    elAuth.style.display="";
    document.getElementById("username").value="";
  };
  document.getElementById("btn-today").onclick = ()=>{
    document.getElementById("work-date").value = todayStr();
    renderCategories();
  };

  function mountUser(){ elAuth.style.display="none"; elAdmin.style.display="none"; elUser.style.display=""; buildToggles(); renderCategories(); }
  function mountAdmin(){ elAuth.style.display="none"; elUser.style.display="none"; elAdmin.style.display=""; }

  const state = { user:null, enabledCats: new Set(Object.keys(CHECKLIST)), photos:{} };

  function todayStr(offsetDays=0){
    const d = new Date(); d.setDate(d.getDate()+offsetDays); d.setHours(12,0,0,0);
    return d.toISOString().slice(0,10);
  }

  function buildToggles(){
    const wrap = document.getElementById("cat-toggles"); wrap.innerHTML="";
    Object.keys(CHECKLIST).forEach(cat=>{
      const label = document.createElement("label"); label.className="toggle";
      const cb = document.createElement("input"); cb.type="checkbox"; cb.checked = state.enabledCats.has(cat);
      cb.onchange = ()=>{
        if(cb.checked) state.enabledCats.add(cat); else state.enabledCats.delete(cat);
        if(state.enabledCats.size===0){ alert("Pilih minimal 1 kategori."); cb.checked=true; state.enabledCats.add(cat); }
        renderCategories();
      };
      const span = document.createElement("span"); span.textContent = cat;
      label.appendChild(cb); label.appendChild(span); wrap.appendChild(label);
    });
  }

  function renderCategories(){
    const wrap = document.getElementById("cats"); wrap.innerHTML="";
    Object.keys(CHECKLIST).forEach(cat=>{
      if(!state.enabledCats.has(cat)) return;
      const card = document.createElement("section"); card.className="category card";
      const head = document.createElement("header"); head.innerHTML = `<h3>${cat}</h3><div class="muted">Semua item wajib dicentang</div>`; card.appendChild(head);
      CHECKLIST[cat].forEach((name,i)=>{
        const idx=i+1;
        const row=document.createElement("div"); row.className="item";
        const inner=document.createElement("div"); inner.className="item-row";
        const cbWrap=document.createElement("div"); const cb=document.createElement("input"); cb.type="checkbox"; cb.id=`cb_${cat}_${idx}`; cbWrap.appendChild(cb);
        const num=document.createElement("div"); num.textContent=idx; num.style.fontWeight="800";
        const nm=document.createElement("div"); nm.textContent=name;
        const upWrap=document.createElement("div"); const fileId=`file_${cat}_${idx}`.replace(/\s+/g,'_');
        const input=document.createElement("input"); input.type="file"; input.accept="image/*"; input.multiple=true; input.id=fileId;
        const label=document.createElement("label"); label.className="file-btn"; label.htmlFor=fileId; label.textContent="Upload Foto";
        upWrap.appendChild(label); upWrap.appendChild(input);
        inner.appendChild(cbWrap); inner.appendChild(num); inner.appendChild(nm); inner.appendChild(upWrap); row.appendChild(inner);
        const photosDiv=document.createElement("div"); photosDiv.className="item-photos"; row.appendChild(photosDiv);
        input.onchange=async ()=>{
          const files=[...input.files]; const out=[];
          for(const f of files){ const blob=await compressImage(f,1600,0.85); const url=URL.createObjectURL(blob); const img=document.createElement("img"); img.className="thumb"; img.src=url; photosDiv.appendChild(img); out.push(blob); }
          state.photos[`${cat}|${idx}`]=(state.photos[`${cat}|${idx}`]||[]).concat(out); input.value="";
        };
        if((REQUIRED_PHOTO_IDX[cat]||[]).includes(idx)){ const badge=document.createElement("span"); badge.className="badge warn"; badge.textContent="foto wajib"; row.appendChild(badge); }
        card.appendChild(row);
      });
      wrap.appendChild(card);
    });
  }

  async function compressImage(file, maxDim=1600, quality=0.85){
    const img=new Image(); const url=URL.createObjectURL(file);
    await new Promise((res,rej)=>{ img.onload=res; img.onerror=rej; img.src=url; });
    let w=img.width, h=img.height; const ratio=Math.min(maxDim/w, maxDim/h, 1);
    const canvas=document.createElement("canvas"); canvas.width=Math.round(w*ratio); canvas.height=Math.round(h*ratio);
    const ctx=canvas.getContext("2d"); ctx.drawImage(img,0,0,canvas.width,canvas.height);
    return await new Promise(r=>canvas.toBlob(b=>{ URL.revokeObjectURL(url); r(b); },"image/jpeg",quality));
  }

  document.getElementById("btn-submit").onclick = async ()=>{
    const name=state.user; const date=document.getElementById("work-date").value;
    if(!name) return alert("Nama user kosong."); if(!date) return alert("Tanggal belum diisi.");

    // Validasi per kategori
    const errs=[]; const payload={};
    for(const cat of Object.keys(CHECKLIST)){
      if(!state.enabledCats.has(cat)) continue;
      const arr=CHECKLIST[cat]; let done=0; const req=new Set(REQUIRED_PHOTO_IDX[cat]||[]); let reqMissing=0;
      for(let i=0;i<arr.length;i++){ const idx=i+1; const checked=document.getElementById(`cb_${cat}_${idx}`)?.checked; if(checked) done++; if(req.has(idx)){ const pics=state.photos[`${cat}|${idx}`]||[]; if(pics.length===0) reqMissing++; } }
      if(done<arr.length) errs.push(`â€¢ ${cat}: semua item harus dicentang (${done}/${arr.length}).`);
      if(reqMissing>0) errs.push(`â€¢ ${cat}: kurang foto wajib (${reqMissing} item).`);
      payload[cat]={done,total:arr.length};
    }
    if(errs.length){ alert("Tidak bisa submit:\n"+errs.join("\n")); return; }

    // Upload foto ke Storage (jika supabase tersedia), bangun peta uploads
    let uploadedMap={};
    if(supabase){
      for(const key of Object.keys(state.photos)){
        const [cat, idx]=key.split("|"); const blobs=state.photos[key]; const uploads=[];
        for(const blob of blobs){
          const path=`${encodeURIComponent(name)}/${date}/${encodeURIComponent(cat)}/${idx}-${Date.now()}-${Math.random().toString(36).slice(2)}.jpg`;
          const { error } = await supabase.storage.from(BUCKET).upload(path, blob, { contentType:"image/jpeg", upsert:false });
          if(error){ console.warn("Upload error", error); }
          const { data:pub } = supabase.storage.from(BUCKET).getPublicUrl(path);
          uploads.push({ item:Number(idx), path, url: pub.publicUrl });
        }
        uploadedMap[key]=uploads;
      }
    }

    // Simpan metadata per kategori
    if(supabase){
      const rows=[];
      for(const cat of Object.keys(CHECKLIST)){
        if(!state.enabledCats.has(cat)) continue;
        const arr=CHECKLIST[cat]; const done=payload[cat].done; const total=payload[cat].total;
        const req=new Set(REQUIRED_PHOTO_IDX[cat]||[]); let miss=0; const ups=[];
        for(let i=1;i<=arr.length;i++){ if(req.has(i)){ const u=uploadedMap[`${cat}|${i}`]||[]; if(u.length===0) miss++; } (uploadedMap[`${cat}|${i}`]||[]).forEach(x=>ups.push(x)); }
        rows.push({ user:name, date, category:cat, total, done, missing_photos:miss, uploads:ups, payload:{ checks:"all-true", required:[...req] } });
      }
      const { error } = await supabase.from("checks").insert(rows);
      if(error){ alert("Gagal menyimpan metadata: "+error.message); return; }
      alert("âœ… Tersimpan ke server.");
    }else{
      // fallback export lokal
      const data={ meta:{ exportedAt:new Date().toISOString(), app:"v6.1.1-fallback" }, user:name, date };
      const blob=new Blob([JSON.stringify(data)],{type:"application/json"});
      const url=URL.createObjectURL(blob); const a=document.createElement("a"); a.href=url; a.download=`fallback_${name}_${date}.json`; a.click();
      alert("âš ï¸ Supabase belum diset. Data diexport lokal.");
    }
    state.photos={};
  };

  document.getElementById("btn-load").onclick = async ()=>{
    if(!supabase) return alert("Supabase belum dikonfigurasi.");
    const f=document.getElementById("from-date").value; const t=document.getElementById("to-date").value;
    const { data, error } = await supabase.from("checks").select("*").gte("date", f).lte("date", t).order("submitted_at",{ascending:false});
    if(error){ alert("Gagal memuat: "+error.message); return; }
    renderAdmin(data||[]);
  };

  function renderAdmin(rows){
    const box=document.getElementById("admin-list"); box.innerHTML="";
    if(rows.length===0){ box.innerHTML='<div class="muted">Tidak ada data.</div>'; return; }
    rows.forEach(r=>{
      const div=document.createElement("div"); div.className="kartu";
      div.innerHTML=`<h4>${r.user} â€” ${r.date} â€” ${r.category}</h4><div class="muted">Progress: ${r.done}/${r.total} Â· Foto wajib kurang: ${r.missing_photos}</div>`;
      const photos=document.createElement("div"); photos.className="photos-row";
      (r.uploads||[]).forEach(u=>{ const img=document.createElement("img"); img.className="thumb"; img.src=u.url; img.title=`Item ${u.item}`; photos.appendChild(img); });
      div.appendChild(photos); box.appendChild(div);
    });
  }
  </script>
</body>
</html>
